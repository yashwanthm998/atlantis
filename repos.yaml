version: 3
repos:
  - id: github.com/yashwanthm998/atlantis
    workflow: custom_workflow
    allowed_overrides: [workflow]
    allow_custom_workflows: true
    autoplan:
      enabled: true
      when_modified: ["*.tf", "*.tfvars"]
 
workflows:
  custom_workflow:
    plan:
      steps:
        - run: rm -rf .terraform .terraform.lock.hcl
        - run: |
            echo "Checking if TF_VAR_GOOGLE_CREDENTIALS is set..."
            if [ -z "$TF_VAR_GOOGLE_CREDENTIALS" ]; then
              echo "ERROR: TF_VAR_GOOGLE_CREDENTIALS is not set"
              exit 1
            fi

            echo "ğŸŸ¢ Current Working Directory:"
            pwd

            echo "ğŸ“„ Listing Files:"
            ls -la

            echo "ğŸ“‘ Printing terraform.tfvars:"
            cat terraform.tfvars || echo "terraform.tfvars not found âŒ"

            echo "ğŸ” Running Terraform Plan"
            terraform plan -out=tfplan

    apply:
      steps:
        - run: terraform apply tfplan